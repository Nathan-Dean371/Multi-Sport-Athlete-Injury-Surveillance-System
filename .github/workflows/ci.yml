# ============================================================================
# Multi-Sport Athlete Injury Surveillance System
# CI/CD Pipeline - Build, Test, and Deploy
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Allow manual triggering

env:
  AWS_REGION: eu-west-1 # Changed to Ireland region
  ECR_REPOSITORY: injury-surveillance-backend
  
jobs:
  # --------------------------------------------------------------------------
  # Job 1: Test Backend
  # --------------------------------------------------------------------------
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: identity_service_test
          POSTGRES_USER: identity_admin
          POSTGRES_PASSWORD: test-password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      neo4j:
        image: neo4j:5.25-community
        env:
          NEO4J_AUTH: neo4j/test-password
        ports:
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p test-password 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Set up test database schema
        run: |
          sudo apt-get update && sudo apt-get install -y postgresql-client
          psql -h localhost -U identity_admin -d postgres -c "DROP DATABASE IF EXISTS identity_service_test;"
          psql -h localhost -U identity_admin -d postgres -f ./database/postgres/init-test-db.sql
          psql -h localhost -U identity_admin -d identity_service_test -f ./database/postgres/identity-service-schema.sql
        env:
          PGPASSWORD: test-password

      - name: Run linter
        working-directory: ./backend
        run: npm run lint

      - name: Run unit tests
        working-directory: ./backend
        run: npm run test:cov
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: identity_service_test
          POSTGRES_USER: identity_admin
          POSTGRES_PASSWORD: test-password
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USERNAME: neo4j
          NEO4J_PASSWORD: test-password
          JWT_SECRET: test-jwt-secret

      - name: Run E2E tests
        working-directory: ./backend
        run: npm run test:e2e
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: identity_service_test
          POSTGRES_USER: identity_admin
          POSTGRES_PASSWORD: test-password
          NEO4J_URI: bolt://localhost:7687
          NEO4J_USERNAME: neo4j
          NEO4J_PASSWORD: test-password
          JWT_SECRET: test-jwt-secret

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          directory: ./backend/coverage
          flags: backend
          fail_ci_if_error: false
  
  # --------------------------------------------------------------------------
  # Job 2: Build and Push Docker Image
  # --------------------------------------------------------------------------
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: test-backend
    # Run on push to main or manual trigger
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    
    outputs:
      image-uri: ${{ steps.image-uri.outputs.uri }}
      ecr-registry: ${{ steps.login-ecr.outputs.registry }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.build.outputs.digest }}"
      
      - name: Set image URI output
        id: image-uri
        run: |
          echo "uri=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:main" >> $GITHUB_OUTPUT
  
  # --------------------------------------------------------------------------
  # Job 3: Deploy to EC2 (Optional - Manual Trigger)
  # --------------------------------------------------------------------------
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          IMAGE_URI: ${{ needs.build-and-push.outputs.image-uri }}
          ECR_REGISTRY: ${{ needs.build-and-push.outputs.ecr-registry }}
        run: |
          # Save SSH key
          echo "$EC2_SSH_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem
          
          # SSH into EC2 and deploy
          ssh -tt -i ec2_key.pem -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # Pull image
            docker pull $IMAGE_URI
            
            # Stop existing container
            docker stop injury-surveillance-backend || true
            docker rm injury-surveillance-backend || true
            
            # Run new container
            docker run -d \
              --name injury-surveillance-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e NODE_ENV=production \
              -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
              -e POSTGRES_HOST=${{ secrets.POSTGRES_HOST }} \
              -e POSTGRES_PORT=${{ secrets.POSTGRES_PORT }} \
              -e POSTGRES_DB=${{ secrets.POSTGRES_DB }} \
              -e POSTGRES_USER=${{ secrets.POSTGRES_USER }} \
              -e POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              -e NEO4J_URI=${{ secrets.NEO4J_URI }} \
              -e NEO4J_USERNAME=${{ secrets.NEO4J_USERNAME }} \
              -e NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }} \
              -e POSTGRES_SSL=${{ secrets.POSTGRES_SSL }} \
              $IMAGE_URI
            
            # Clean up old images
            docker image prune -f
          EOF
          
          # Clean up SSH key
          rm ec2_key.pem

  # --------------------------------------------------------------------------
  # Job 4: Smoke Test
  # --------------------------------------------------------------------------
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: deploy-to-ec2
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Wait for container to be ready
        run: sleep 15

      - name: Hit health endpoint
        run: |
          RESPONSE=$(curl -sf --retry 5 --retry-delay 5 --retry-connrefused \
            http://${{ secrets.EC2_HOST }}:3000/health)
          echo "Health response: $RESPONSE"
          echo "$RESPONSE" | grep -q '"status":"ok"' || (echo "Health check failed" && exit 1)