# ADR-0004.1: MVP Endpoints Implementation Strategy

**Status:** Accepted

**Date:** January 2025

**Deciders:** Nathan Dean

**Parent ADR:** [ADR-0004: NestJS Backend Framework](./adr-0004-nestjs-backend-framework.md)

---

## Decision

We will implement endpoints in **three phases** with the following strategy:

### Phase 1: MVP Endpoints (7 endpoints)

Priority order for implementation:

#### 1. Authentication Domain (3 endpoints)
**Implementation Order: 1st**
- `POST /auth/register` - Create new user account
- `POST /auth/login` - Authenticate user and return JWT
- `POST /auth/refresh-token` - Get new access token

**Rationale**: Foundation for all other features. Nothing works without authentication.

**Implementation Details**:
- JWT-based authentication with access/refresh tokens
- Role-based guards (Player, Coach, Admin)
- Password hashing with bcrypt
- Token stored in PostgreSQL Identity table

**Dependencies**:
- PostgreSQL Identity database setup
- JWT module configuration
- Passport.js integration

---

#### 2. Players Domain (2 endpoints)
**Implementation Order: 2nd**
- `GET /players/:playerId` - Get player profile
- `PATCH /players/:playerId/status` - Update daily status (GREEN/ORANGE/RED) **CRITICAL PATH**

**Rationale**: Core player functionality. Status updates are the primary daily interaction.

**Implementation Details**:
- Player status updates create relationships in Neo4j
- Status history maintained for analytics
- Guard: JwtAuthGuard + PlayerOwnershipGuard (can only update own status)
- Emit events for coach notifications

**Neo4j Queries**:
```cypher
// Update status
MATCH (p:Player {pseudoId: $playerId})
CREATE (s:StatusUpdate {
  id: randomUUID(),
  status: $status,
  date: date(),
  timestamp: datetime(),
  notes: $notes
})
CREATE (p)-[:HAS_STATUS]->(s)
RETURN s
```

**Dependencies**:
- Neo4j Player nodes created during registration
- Identity service for pseudoId resolution

---

#### 3. Injuries Domain (2 endpoints)
**Implementation Order: 3rd**
- `POST /injuries/` - Report new injury **CRITICAL PATH**
- `GET /injuries/:injuryId` - Get injury details

**Rationale**: Core feature of the application. Players report injuries, coaches need to see them.

**Implementation Details**:
- Body map data stored as JSON
- Injury severity triggers automatic coach notifications
- Creates Injury node and HAS_INJURY relationship
- Guard: JwtAuthGuard (players and medical staff can report)

**Neo4j Queries**:
```cypher
// Create injury
MATCH (p:Player {pseudoId: $playerId})
CREATE (i:Injury {
  id: randomUUID(),
  bodyPart: $bodyPart,
  injuryType: $injuryType,
  severity: $severity,
  painLevel: $painLevel,
  occurredAt: datetime($occurredAt),
  reportedAt: datetime(),
  isResolved: false,
  mechanism: $mechanism
})
CREATE (p)-[:HAS_INJURY {
  reportedBy: $reportedBy,
  context: $context
}]->(i)
RETURN i
```

**Dependencies**:
- Player profile exists
- Notification service for alerting coaches

---

#### 4. Coaches Domain (2 endpoints)
**Implementation Order: 4th**
- `GET /coaches/:coachId` - Get coach profile
- `GET /coaches/teams/:teamId/players` - Get team roster with status **CRITICAL PATH**

**Rationale**: Coaches need to see their team and player statuses. This is their primary dashboard view.

**Implementation Details**:
- Returns aggregated player data with latest status
- Shows active injuries count per player
- Guard: JwtAuthGuard + CoachTeamAccessGuard
- Caching recommended for team roster queries

**Neo4j Queries**:
```cypher
// Get team roster with statuses
MATCH (t:Team {id: $teamId})<-[:PLAYS_FOR]-(p:Player)
OPTIONAL MATCH (p)-[:HAS_STATUS]->(s:StatusUpdate)
WHERE s.date = date()
OPTIONAL MATCH (p)-[:HAS_INJURY]->(i:Injury {isResolved: false})
RETURN p, s, count(i) as activeInjuries
ORDER BY p.lastName
```

**Dependencies**:
- Team and Player relationships established
- Status updates being recorded

---

#### 5. Teams Domain (1 endpoint)
**Implementation Order: 5th**
- `GET /teams/:teamId` - Get team details

**Rationale**: Basic team information for display purposes.

**Implementation Details**:
- Simple team metadata retrieval
- Guard: JwtAuthGuard (any authenticated user can view teams they belong to)
- Returns team name, sport, coach info

---

#### 6. Notifications Domain (1 endpoint)
**Implementation Order: 6th**
- `POST /notifications/token` - Register FCM device token

**Rationale**: Enables push notifications for injury alerts and status updates.

**Implementation Details**:
- Store device tokens in PostgreSQL
- Link tokens to user accounts
- Support multiple devices per user
- Update token on each app startup

**Dependencies**:
- Firebase Cloud Messaging configured
- Device token management in PostgreSQL

---

### Phase 2: Enhanced Endpoints (10 endpoints)

Endpoints to implement after MVP is functional:

**Authentication**:
- `POST /auth/logout` - Invalidate refresh token

**Players**:
- `PATCH /players/:playerId` - Update player profile
- `GET /players/:playerId/injuries` - Get injury history
- `GET /players/:playerId/teams` - Get teams player belongs to

**Coaches**:
- `GET /coaches/teams` - Get all teams managed by coach
- `GET /coaches/dashboard` - Get aggregated dashboard data

**Injuries**:
- `PATCH /injuries/:injuryId` - Update injury details
- `POST /injuries/:injuryId/resolve` - Mark injury as resolved

**Teams**:
- `GET /teams/` - List all teams (admin)

**Notifications**:
- `GET /notifications/` - Get notification history
- `PATCH /notifications/preferences` - Update notification settings

---

### Phase 3: Future Enhancements (15 endpoints)

Nice-to-have features for full system:

**Authentication**:
- `POST /auth/forgot-password` - Password reset flow

**Players**:
- `DELETE /players/:playerId` - GDPR deletion

**Coaches**:
- `GET /coaches/teams/:teamId/analytics` - Advanced injury analytics

**Injuries**:
- `POST /injuries/:injuryId/recovery-update` - Track recovery progress

**Teams**:
- `POST /teams/` - Create team (admin)
- `PATCH /teams/:teamId` - Update team
- `POST /teams/:teamId/players/:playerId` - Add player to team
- `DELETE /teams/:teamId/players/:playerId` - Remove player

**Organizations**:
- Complete organization management CRUD

**Analytics**:
- Advanced reporting and data visualization

---

## Implementation Approach

### Module Structure

```
backend/src/
├── auth/
│   ├── auth.module.ts
│   ├── auth.controller.ts
│   ├── auth.service.ts
│   ├── strategies/
│   │   ├── jwt.strategy.ts
│   │   └── refresh-jwt.strategy.ts
│   ├── guards/
│   │   ├── jwt-auth.guard.ts
│   │   └── roles.guard.ts
│   └── dto/
│       ├── register.dto.ts
│       ├── login.dto.ts
│       └── refresh-token.dto.ts
├── players/
│   ├── players.module.ts
│   ├── players.controller.ts
│   ├── players.service.ts
│   ├── guards/
│   │   └── player-ownership.guard.ts
│   └── dto/
│       ├── update-status.dto.ts
│       └── player-profile.dto.ts
├── injuries/
│   ├── injuries.module.ts
│   ├── injuries.controller.ts
│   ├── injuries.service.ts
│   └── dto/
│       ├── create-injury.dto.ts
│       └── injury-details.dto.ts
├── coaches/
│   ├── coaches.module.ts
│   ├── coaches.controller.ts
│   ├── coaches.service.ts
│   ├── guards/
│   │   └── coach-team-access.guard.ts
│   └── dto/
│       └── team-roster.dto.ts
├── teams/
│   ├── teams.module.ts
│   ├── teams.controller.ts
│   ├── teams.service.ts
│   └── dto/
│       └── team-details.dto.ts
├── notifications/
│   ├── notifications.module.ts
│   ├── notifications.controller.ts
│   ├── notifications.service.ts
│   └── dto/
│       └── register-token.dto.ts
├── database/
│   ├── database.module.ts
│   ├── neo4j/
│   │   └── neo4j.service.ts
│   └── postgres/
│       └── identity.entity.ts
└── common/
    ├── guards/
    ├── interceptors/
    ├── decorators/
    └── filters/
```

### Testing Strategy

**Unit Tests** (per module):
- Service layer business logic
- Guard authorization logic
- DTO validation

**Integration Tests** (per module):
- Controller endpoints with mocked database
- Service interactions with Neo4j/PostgreSQL
- Authentication flow

**E2E Tests** (critical paths):
1. Complete authentication flow
2. Player reports injury → Coach sees notification
3. Player updates status → Appears on coach dashboard
4. Register device token → Receive push notification

---

### Database Dependencies

#### PostgreSQL (Identity Database)
**Required for MVP**:
- `Identity` table (email, hashedPassword, role, pseudoId)
- `DeviceToken` table (userId, fcmToken, platform)
- `RefreshToken` table (token, userId, expiresAt)

**Setup Priority**: Highest (required before endpoint implementation)

#### Neo4j (Graph Database)
**Required for MVP**:
- `Player` nodes (pseudoId, sport, ageGroup)
- `Coach` nodes (pseudoId)
- `Team` nodes (id, name, sport)
- `Injury` nodes (all injury properties)
- `StatusUpdate` nodes (status, date, timestamp)
- `PLAYS_FOR` relationships (Player-Team)
- `COACHES` relationships (Coach-Team)
- `HAS_INJURY` relationships (Player-Injury)
- `HAS_STATUS` relationships (Player-StatusUpdate)

**Setup Priority**: Highest (required before endpoint implementation)

---

### API Documentation

**OpenAPI/Swagger**:
- Generate automatically from NestJS decorators
- Available at `/api/docs` in development
- Include request/response examples
- Document authentication requirements

**Sample Endpoint Documentation**:
```typescript
@ApiTags('injuries')
@ApiBearerAuth()
@UseGuards(JwtAuthGuard)
@Controller('injuries')
export class InjuriesController {
  @Post()
  @ApiOperation({ summary: 'Report a new injury' })
  @ApiResponse({ status: 201, description: 'Injury created successfully' })
  @ApiResponse({ status: 401, description: 'Unauthorized' })
  @ApiResponse({ status: 400, description: 'Invalid input' })
  async create(@Body() createInjuryDto: CreateInjuryDto) {
    // Implementation
  }
}
```

---

## Related Decisions

- **[ADR-0004: NestJS Backend Framework](./adr-0004-nestjs-backend-framework.md)** - Parent decision
- **[ADR-0002: Neo4j Graph Database](./adr-0002-neo4j-graph-database.md)** - Database for analytical data
- **[ADR-0003: Two-Database Privacy Architecture](./adr-0003-two-database-privacy-architecture.md)** - Identity management
- **[ADR-0006: JWT-Based Authentication](./adr-0006-jwt-authentication.md)** - Authentication strategy
- **[ADR-0005: React Native Mobile](./adr-0005-react-native-mobile.md)** - Primary client application

---

## References

- [API Endpoints Specification](../../Html%20Docs/api_endpoints.html)
- [Sprint 1 Planning](../../sprints/Planning%20Sprint%201.md)
- [NestJS Documentation](https://docs.nestjs.com/)
- [Neo4j Cypher Manual](https://neo4j.com/docs/cypher-manual/current/)
- [Firebase Cloud Messaging](https://firebase.google.com/docs/cloud-messaging)

---

**Last Updated**: January 2025  
**Version**: 1.0  
**Status**: Ready for Implementation
